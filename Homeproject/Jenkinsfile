pipeline {
    agent any

    tools {
        maven 'maven'
    }

    environment {
        // Update these for your setup
        GIT_URL = 'https://github.com/charan0407/myproject.git'
        GIT_BRANCH = 'UAT'
        REGISTRY = 'docker.io/charan0407'         // DockerHub username
        IMAGE_NAME = 'myproject'
        DOCKER_CREDENTIALS = 'dockerhub-creds'    // Jenkins credentials ID for Docker Hub
        GIT_CREDENTIALS = 'github-creds'          // Jenkins credentials ID for GitHub
    }

    stages {

        stage('Checkout Code') {
            steps {
                echo 'üì¶ Cloning repository...'
        deleteDir()
        git branch: "${GIT_BRANCH}", url: "${GIT_URL}"
            }
        }

        stage('Build with Maven') {
            steps {
                dir('Homeproject') {
                    echo '‚öôÔ∏è Running mvn clean package...'
                    sh 'mvn clean package -DskipTests'
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                dir('Homeproject') {
                    script {
                        echo 'üê≥ Building Docker image...'
                        sh """
                            docker build -t $REGISTRY/$IMAGE_NAME:${BUILD_NUMBER} .
                        """
                    }
                }
            }
        }

        stage('Push Docker Image') {
            steps {
                script {
                    echo 'üì§ Pushing Docker image to registry...'

                    withCredentials([usernamePassword(
                        credentialsId: "${DOCKER_CREDENTIALS}",
                        usernameVariable: 'DOCKER_USER',
                        passwordVariable: 'DOCKER_PASS'
                    )]) {
                        sh """
                            echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin $REGISTRY
                            docker push $REGISTRY/$IMAGE_NAME:${BUILD_NUMBER}
                            docker tag $REGISTRY/$IMAGE_NAME:${BUILD_NUMBER} $REGISTRY/$IMAGE_NAME:latest
                            docker push $REGISTRY/$IMAGE_NAME:latest
                            docker logout $REGISTRY
                        """
                    }
                }
            }
        }

        stage('Update K8s Manifest for ArgoCD') {
            steps {
                withCredentials([usernamePassword(
                    credentialsId: "${GIT_CREDENTIALS}",
                    usernameVariable: 'GIT_USER',
                    passwordVariable: 'GIT_PASS'
                )]) {
                    sh """
    git config user.email "jenkins@charan.live"
    git config user.name "Jenkins CI"

    # Make sure we are on UAT branch
    git checkout ${GIT_BRANCH}

    # Pull latest changes to avoid non-fast-forward errors
    git fetch origin ${GIT_BRANCH}
    git rebase origin/${GIT_BRANCH}

    # Update image tag in k8s.yaml
    sed -i 's#docker.io/charan0407/myproject:.*#docker.io/charan0407/myproject:${BUILD_NUMBER}#' Homeproject/manifest/k8s.yaml

    # Commit and push changes
    git add Homeproject/manifest/k8s.yaml
    git commit -m "Update image tag to ${BUILD_NUMBER}" || echo "No changes to commit"
    git push https://${GIT_USER}:${GIT_PASS}@github.com/charan0407/myproject.git ${GIT_BRANCH}
                    """
                }
            }
        }
    }

    post {
        success {
            echo "‚úÖ Successfully built and pushed: $REGISTRY/$IMAGE_NAME:${BUILD_NUMBER}"
        }
        failure {
            echo "‚ùå Build failed!"
        }
    }
}
